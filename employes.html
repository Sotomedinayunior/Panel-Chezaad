<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Mi Ponche</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    padding: 30px;
    display: flex;
    justify-content: center;
  }
  .card {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    width: 320px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
  }
  .card img {
    width: 88px;
    height: 88px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
    border: 2px solid #eee;
  }
  h3 {
    margin: 6px 0 2px;
  }
  .estado-ok { color: #28a745; font-weight: bold; }
  .estado-off { color: #dc3545; font-weight: bold; }
  .estado-error { color: gray; font-weight: bold; }
  .info {
    font-size: 14px;
    margin: 4px 0;
  }
  button.ingresar, button.salir {
    border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; margin-top: 12px; font-weight: 600;
  }
  button.ingresar { background-color: #28a745; color: white; }
  button.salir { background-color: #dc3545; color: white; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    align-items: center; justify-content: center;
    padding: 16px;
  }
  .modal-content {
    background: #fff;
    padding: 51px 20px 16px;
    border-radius: 8px;
    max-width: 480px;
    width: 100%;
  }
  .modal-header {
    font-weight: 700; font-size: 18px; margin-bottom: 8px;
  }
  .modal-sub {
    color: #555; font-size: 14px; margin-bottom: 10px;
  }
  .modal-content textarea {
    width: 100%;
    height: 110px;
    margin: 6px 0 8px;
    padding: 10px;
    resize: vertical;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: inherit;
  }
  .modal-actions {
    display: flex; gap: 8px; justify-content: flex-end; margin-top: 6px;
  }
  .btn-cancel {
    background: #6c757d; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer;
  }
  .btn-send {
    background: #dc3545; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 700;
  }
  .small {
    font-size: 12px; color: #777; margin-top: 6px;
  }
</style>
</head>
<body>

<div id="cardContainer">
  <p>Cargando datos...</p>
</div>

<!-- Modal de reporte -->
<div id="modalSalida" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header" id="modalTitle">Confirmar salida</div>
    <div class="modal-sub">Antes de salir, escribe un breve reporte de tus actividades.</div>
    <textarea id="reporteSalida" placeholder="Escribe tu reporte aqu√≠..."></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-send" onclick="enviarSalida()">Enviar reporte y salir</button>
    </div>
    <div class="small">Este reporte se enviar√° de forma privada a los supervisores.</div>
  </div>
</div>

<script>
/** CONFIG **/
const webhookBase = "https://chezaad-nfr.bitrix24.com/rest/435/7ywb7o58ugno9e0t/";
/** IDs de supervisores (USUARIOS) que deben recibir el reporte en privado */
const SUPERVISOR_IDS = ['1']; // <-- CAMBIA ESTO por los IDs reales
/** (Opcional) ID de grupo si prefieres enviar al grupo de supervisores */
const SUPERVISOR_GROUP_ID = ''; // ejemplo: '5'  => si lo rellenas, tambi√©n se enviar√° al grupo

/** ESTADO **/
let usuarioActualId = null;
let usuarioNombre = "";
let usuarioEmail = "";
let cacheEmpleado = null;

/** Util **/
function toTime(t) {
  try { return t ? new Date(t).toLocaleTimeString() : '‚Äî'; } catch(e) { return '‚Äî'; }
}
function esUrl(str){ return typeof str === 'string' && /^https?:\/\//i.test(str); }

/** Carga usuario logueado y pinta la card **/
async function obtenerUsuarioActual() {
  const container = document.getElementById("cardContainer");
  try {
    const res = await fetch(webhookBase + "profile.json");
    const data = await res.json();
    if (!data?.result?.ID) throw new Error('No se obtuvo el profile');
    usuarioActualId = data.result.ID;
    usuarioNombre = (data.result.NAME || '') + ' ' + (data.result.LAST_NAME || '');
    usuarioEmail = data.result.EMAIL || '';
    await obtenerUsuario(usuarioActualId);
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>‚ùå Error al obtener el usuario actual</p>";
  }
}

async function obtenerUsuario(id) {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "<p>Cargando...</p>";

  try {
    const res = await fetch(webhookBase + `user.get.json?ID=${id}`);
    const data = await res.json();
    const emp = data?.result?.[0];
    if (!emp) { container.innerHTML = "<p>‚ùå Usuario no encontrado</p>"; return; }
    cacheEmpleado = emp;

    // Estado de timeman
    let estado = "Sin acceso", inicio = "‚Äî", fin = "‚Äî", horas = "‚Äî";
    let estadoClase = "estado-error";
    let boton = "";

    try {
      const statusRes = await fetch(webhookBase + `timeman.status.json?user_id=${emp.ID}`);
      const statusData = await statusRes.json();
      if (statusData?.result) {
        const st = statusData.result;
        const abierto = st.STATUS === "OPENED";
        estado = abierto ? "En l√≠nea" : "Fuera";
        estadoClase = abierto ? "estado-ok" : "estado-off";
        inicio = toTime(st.TIME_START);
        fin = toTime(st.TIME_FINISH);

        if (abierto && st.TIME_START) {
          const diffHrs = (new Date() - new Date(st.TIME_START)) / 36e5;
          horas = Math.floor(diffHrs) + " hrs";
        } else if (st.DURATION) {
          horas = Math.floor(parseFloat(st.DURATION)) + " hrs";
        }

        boton = abierto
          ? `<button class="salir" onclick="abrirModal()">Salir</button>`
          : `<button class="ingresar" onclick="marcarPonche('ingresar', ${emp.ID})">Ingresar</button>`;
      }
    } catch (e) {
      console.warn("No se pudo leer timeman:", e);
    }

    // Foto (si el campo es ID num√©rico, usa placeholder)
    const foto = esUrl(emp.PERSONAL_PHOTO) ? emp.PERSONAL_PHOTO : 'https://via.placeholder.com/88';

    container.innerHTML = `
      <div class="card">
        <img src="${foto}" alt="Foto">
        <h3>${emp.NAME || ''} ${emp.LAST_NAME || ''}</h3>
        <div class="${estadoClase}">${estado}</div>
        <p class="info">Inicio: ${inicio}</p>
        <p class="info">Fin: ${fin}</p>
        <p class="info">Horas: ${horas}</p>
        ${boton}
      </div>
    `;
  } catch (error) {
    console.error(error);
    container.innerHTML = "<p>‚ùå Error al cargar usuario</p>";
  }
}

/** Modal **/
function abrirModal() {
  document.getElementById("modalSalida").style.display = "flex";
  document.getElementById("reporteSalida").value = "";
  document.getElementById("reporteSalida").focus();
}
function cerrarModal() {
  document.getElementById("modalSalida").style.display = "none";
}

/** Enviar reporte privado a Bitrix y luego salir **/
async function enviarSalida() {
  const reporte = (document.getElementById("reporteSalida").value || "").trim();
  if (!reporte) {
    alert("Por favor escribe un reporte antes de salir.");
    return;
  }

  try {
    await enviarReportePrivadoBitrix(reporte);
  } catch (e) {
    console.error("Error enviando reporte:", e);
    alert("‚ùå No se pudo enviar el reporte a Bitrix. Intenta de nuevo.");
    return;
  }

  try {
    await marcarPonche('salir', usuarioActualId);
  } catch (e) {
    console.error("Error marcando salida:", e);
    alert("‚ùå El reporte se envi√≥, pero no se pudo marcar la salida.");
    return;
  }

  cerrarModal();
  alert("‚úÖ Reporte enviado y salida marcada");
  obtenerUsuario(usuarioActualId);
}

/** Crea un post en el livefeed con visibilidad privada (supervisores) **/
async function enviarReportePrivadoBitrix(reporte) {
  const titulo = `Reporte de salida - ${usuarioNombre}`.trim();
  const mensaje = `üïí Reporte generado al marcar salida\n\n${reporte}\n\n‚Äî Usuario: ${usuarioNombre} (${usuarioEmail})`;

  // Usamos FormData para SPERM[U][] / SPERM[SG][]
  const fd = new FormData();
  fd.append("POST_TITLE", titulo);
  fd.append("POST_MESSAGE", mensaje);

  // Privado a usuarios (supervisores)
  (SUPERVISOR_IDS || []).forEach(uid => {
    if (uid) fd.append("SPERM[U][]", String(uid));
  });

  // (Opcional) Privado a un grupo de supervisores
  if (SUPERVISOR_GROUP_ID) {
    fd.append("SPERM[SG][]", String(SUPERVISOR_GROUP_ID));
  }

  // Importante: NO incluir SPERM[UA] para evitar que sea p√∫blico

  const resp = await fetch(webhookBase + "log.blogpost.add", {
    method: "POST",
    body: fd
  });

  const json = await resp.json();
  if (!json || json.error) {
    console.error("Bitrix error:", json);
    throw new Error(json?.error_description || "Fallo en log.blogpost.add");
  }
}

/** Marcar entrada/salida **/
async function marcarPonche(accion, id) {
  const endpoint = accion === 'ingresar' ? 'timeman.open.json' : 'timeman.close.json';
  const url = `${webhookBase}${endpoint}?user_id=${id}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data || data.error) {
    throw new Error(data?.error_description || "Fallo al marcar ponche");
  }
}

/** Init **/
obtenerUsuarioActual();
</script>

</body>
</html>
