<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    .card{max-width:420px;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;margin-right:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Chezaad Ponche</h2>
    <p id="user"></p>
    <p><strong>Estado:</strong> <span id="status">...</span></p>
    <div style="margin-top:10px">
      <button id="btn-in">Marcar entrada</button>
      <button id="btn-pause">Pausar</button>
      <button id="btn-continue">Continuar</button>
      <button id="btn-out">Marcar salida</button>
    </div>
  </div>

  <script>
    BX24.init(function () {
      // Mostrar usuario actual
      BX24.callMethod('user.current', {}, function (res) {
        if (res.error()) { console.error(res.error()); return; }
        const u = res.data();
        document.getElementById('user').textContent = `${u.NAME} ${u.LAST_NAME} (${u.EMAIL || 'sin email'})`;
      });

      function cargarEstado(){
        BX24.callMethod('timeman.status', {}, function (res) {
          if (res.error()) { console.error(res.error()); return; }
          document.getElementById('status').textContent = res.data().STATUS; // OPEN/PAUSED/CLOSED
        });
      }
      cargarEstado();

      // Acciones de ponche (se ejecutan con el usuario logueado)
      document.getElementById('btn-in').onclick = () => {
        BX24.callMethod('timeman.open', {}, () => cargarEstado());
      };
      document.getElementById('btn-pause').onclick = () => {
        BX24.callMethod('timeman.pause', {}, () => cargarEstado());
      };
      document.getElementById('btn-continue').onclick = () => {
        BX24.callMethod('timeman.continue', {}, () => cargarEstado());
      };
      document.getElementById('btn-out').onclick = () => {
        const report = prompt('Comentario del cierre (opcional):','');
        BX24.callMethod('timeman.close', report ? { REPORT: report } : {}, () => cargarEstado());
      };
    });
  </script>
</body>
</html>
